<!DOCTYPE html>
<html lang="en">

<head>
    <title>Quiz</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
    <link rel="stylesheet" type="text/css" href="vendor/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
</head>

<body>
    <div class="limiter">
        <div class="container-login100">
            <div class="wrap-login100" style="width:80%;  padding: 77px 55px 33px 60px;">
                <span class="login100-form-title p-b-26">
                    Quiz
                </span>
                <span class="login100-form-title p-b-48">
                    <a class='navbar-brand' href='../index.html'><img src="logo1.png"
                            style="margin-top:20px;height: 90px;" alt="image"></a>
                </span>
                <form class="login100-form validate-form">



                    <div class="container-login100-form-btn">
                        <div class="wrap-login100-form-btn">
                            <div class="login100-form-bgbtn"></div>
                            <button class="login100-form-btn" type="button" id="submitQuiz">
                                Submit Quiz
                            </button>
                        </div>
                    </div>

                    <div class="text-center p-t-115">
                        <span class="txt1">
                            Donâ€™t have an account?
                        </span>
                        <a class="txt2" href="signup.html">
                            Sign Up
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="dropDownSelect1"></div>

    <!-- JS -->
    <script src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="vendor/animsition/js/animsition.min.js"></script>
    <script src="vendor/bootstrap/js/popper.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/select2/select2.min.js"></script>
    <script src="vendor/daterangepicker/moment.min.js"></script>
    <script src="vendor/daterangepicker/daterangepicker.js"></script>
    <script src="vendor/countdowntime/countdowntime.js"></script>
    <script src="js/main.js"></script>
    <!-- <script>
        // Display points when an option is selected
        document.querySelectorAll('.form-check-input').forEach(function (input) {
            input.addEventListener('change', function () {
                var points = this.getAttribute('data-points');
                this.parentNode.querySelector('.points').textContent = '(' + points + ' points)';
                // Hide other points
                this.parentNode.parentNode.querySelectorAll('.points').forEach(function (span) {
                    if (span !== input.parentNode.querySelector('.points')) {
                        span.textContent = '';
                    }
                });
            });
        });

        // Handle quiz submission
        document.getElementById('submitQuiz').addEventListener('click', function () {
            var answers = {};
            document.querySelectorAll('.form-check-input:checked').forEach(function (input) {
                answers[input.getAttribute('name')] = input.value;
            });
            // Send answers to the server for processing or display
            console.log(answers);
        });
    </script> -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch questions data from the backend
                const response = await fetch('http://localhost:8800/question/getAll'); // Use your actual API endpoint here

                if (!response.ok) {
                    throw new Error(`Failed to fetch questions: ${response.statusText}`);
                }

                // Parse the JSON response
                const questions = await response.json();

                // Populate the form with questions
                const form = document.querySelector('.login100-form');

                questions.forEach((question, index) => {
                    // Create a container for the question
                    const questionContainer = document.createElement('div');
                    questionContainer.classList.add('wrap-input100', 'validate-input');

                    // Create the question title element
                    const questionTitle = document.createElement('p');
                    questionTitle.textContent = `${index + 1}. ${question.title}`;
                    questionContainer.appendChild(questionTitle);
                    questionTitle.id = question._id;

                    // Create radio button group for each option
                    question.options.forEach((option, optionIndex) => {
                        // Create radio button input
                        const optionInput = document.createElement('input');
                        optionInput.type = 'radio';
                        optionInput.name = `q${index + 1}`;
                        optionInput.id = `q${index + 1}-option${optionIndex + 1}`;
                        optionInput.value = option.option;
                        optionInput.classList.add('form-check-input');
                        optionInput.setAttribute('data-points', option.points);

                        // Create label for the radio button
                        const optionLabel = document.createElement('label');
                        optionLabel.classList.add('form-check-label');
                        optionLabel.setAttribute('for', optionInput.id);
                        optionLabel.textContent = option.details;

                        // Create span for the points display
                        const pointsSpan = document.createElement('span');
                        pointsSpan.classList.add('points');

                        // Create a wrapper div for the option and append the elements
                        const optionWrapper = document.createElement('div');
                        optionWrapper.classList.add('form-check');
                        optionWrapper.appendChild(optionInput);
                        optionWrapper.appendChild(optionLabel);
                        optionWrapper.appendChild(pointsSpan);

                        // Append the option to the question container
                        questionContainer.appendChild(optionWrapper);
                    });

                    // Append the question container to the form
                    form.insertBefore(questionContainer, form.querySelector('.container-login100-form-btn'));
                });

                // Add event listeners for option selection
                document.querySelectorAll('.form-check-input').forEach(function (input) {
                    input.addEventListener('change', function () {
                        const points = this.getAttribute('data-points');
                        this.parentNode.querySelector('.points').textContent = `(${points} points)`;
                        // Hide other points
                        this.parentNode.parentNode.querySelectorAll('.points').forEach(function (span) {
                            if (span !== input.parentNode.querySelector('.points')) {
                                span.textContent = '';
                            }
                        });
                    });
                });
            } catch (error) {
                console.error('Error fetching questions:', error);
            }
        });


        // Attach event listener to the submit button
        document.getElementById('submitQuiz').addEventListener('click', async function () {
            // Gather answers from the form
            const answers = [];
            document.querySelectorAll('.wrap-input100').forEach((questionWrapper, index) => {
                const form = document.querySelector('.login100-form');
                const p = form.querySelector('.wrap-input100 > p')
                const questionId = p.id;
                const selectedInput = questionWrapper.querySelector('.form-check-input:checked');
                
                if (selectedInput) {
                    const answerValue = selectedInput.value;
                    const obtainPoints = parseInt(selectedInput.getAttribute('data-points'), 10);

                    // Add the answer to the answers array
                    answers.push({
                        question: questionId,
                        obtainPoints: obtainPoints
                    });
                }
            });

            // Define the user ID (e.g., from session or authentication context)
            const user = JSON.parse(localStorage.getItem('user'))
            if(user == null) {
                window.location.href = './signin.html';
                return
            }
            const userId = user._id;

            // Send the answers to the backend
            try {
                const response = await fetch('http://localhost:8800/answer/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user: userId,
                        marks: answers,
                    }),
                });

                // Parse the JSON response
                const result = await response.json();

                // Handle server response
                if (response.ok) {
                    // Handle successful submission (e.g., display success message)
                    alert('Quiz submitted successfully!');
                    // Optionally, you can redirect or reset the form after successful submission
                } else {
                    // Handle error response (e.g., display error message)
                    alert(`Error submitting quiz: ${result.error}`);
                }
            } catch (error) {
                // Handle fetch error (e.g., network issues)
                console.error('Error submitting quiz:', error);
                alert('An error occurred while submitting the quiz. Please try again later.');
            }
        });


    </script>
</body>

</html>
