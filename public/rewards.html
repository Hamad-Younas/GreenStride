<!DOCTYPE html>
<html lang="en">

<!-- Basic -->
<meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Mobile Metas -->
<link rel="stylesheet" href="portfolio.css">
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Site Metas -->
<title>GreenStride | Rewards</title>
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="author" content="">

<style>
  body {
    min-height: 100vh;
    background: #fafafa;
  }


  .social-link {
    width: 30px;
    height: 30px;
    border: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    border-radius: 50%;
    transition: all 0.3s;
    font-size: 0.9rem;
  }

  .social-link:hover,
  .social-link:focus {
    background: #ddd;
    text-decoration: none;
    color: #555;
  }

  .progress {
    height: 10px;
  }

  .row:after {
    content: "";
    display: table;
    clear: both;
  }

  @media screen and (max-width: 600px) {
    .port {
      max-width: 300px;
    }
  }
</style>
<!-- Site Icons -->
<link rel="shortcut icon" href="images/logo.png" type="image/x-icon" />
<link rel="apple-touch-icon" href="images/logo.png">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="css/bootstrap.min.css">
<!-- Site CSS -->
<link rel="stylesheet" href="style.css">
<!-- Responsive CSS -->
<link rel="stylesheet" href="css/responsive.css">
<!-- Custom CSS -->
<link rel="stylesheet" href="css/custom.css">

<!-- Modernizer for Portfolio -->
<script src="js/modernizer.js"></script>






</head>

<body>
  <div class="top-bar">
    <header class="header header_style_01">
      <nav class="megamenu navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" style="border-radius: 10px;color: #4a66ff;"
              data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class='navbar-brand' href='index.html'><img src="images/logo1.png" style="margin-top: -20px;height:80px;"
                alt="image"></a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
              <li><a class='w-full' href='index.html'>Home</a></li>
              <li class="w-full"><a href='contact.html'>Contact Us</a></li>
              <li><a class="active" href='rewards.html'>Reward</a></li>
              <li class="hidden" id="dashboard"><a href='./user dashboard/index.html'>Dashboard</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/add_question.html'>Add Question</a></li>
              <li class="w-full"><a class="hidden" href='./forms/index.html'>Quiz</a></li>
              <li class="w-full"><a class="hidden" href='./forms/forgetpassword.html'>Forget Pass</a></li>
              <li> <a href="./forms/signin.html" onclick="handleLogout()" class="btn btn-light btn-radius btn-brd grd1 " id="signinbutton"
                  style="padding: 15px !important; border:solid 2px #afc845 !important; color: #afc845;border-radius: 40px; ">Signin</a>
              </li>

            </ul>

          </div>
        </div>
      </nav>
    </header>

    <div class="banner-area banner-bg-1">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="banner">
              <h2>Rewards</h2>
              <ul class="page-title-link">
                <li><a href="#">Home</a></li>
                <li><a href="#">Rewards</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="portfolio" class="section wb">
      <div class="container">
        <div class="section-title text-center">
          <h3>Rewards</h3>
        </div><!-- end title -->
      </div><!-- end container -->

      <hr class="invis">
      <center>
        <!-- Portfolio -->
        <div class="card-deck" style="margin: 30px;">
          <div id="couponContainer"></div>
        </div>

        <!-- Popup CSS Start -->
        <style type="text/css">
          .popupContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
          }

          .popupContent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
          }

          .closeBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: gray;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 999;
          }

          .popupBtn {
            margin: 10px;
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          }
        </style>
        <div class="popupContainer">
          <div class="popupContent">
            <button class="closeBtn">Close</button>
            <h1 style="font-weight:600; font-size:35px;">Reward Title</h1>
            <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs"
              type="module"></script><dotlottie-player
              src="https://lottie.host/155faca9-4ae4-40bd-9ad3-e53df53d1898/vMGdFLQn0L.json" background="transparent"
              speed="1" style="width: 450px; height: 450px" direction="1" playMode="normal" loop
              autoplay></dotlottie-player>
            <p style="font-size: 18px;">Description</p>
          </div>
        </div>

        <!-- Popup CSS END -->
        <!-- Award Popup End -->
    </div><!-- end section -->


    <footer class="footer">
      <div class="container">
        <div class="row">
          <div class="col-md-4 col-sm-4 col-xs-12">
            <div class="widget clearfix">
              <div class="widget-title">
                <a href='index.html'><img src="images/logo1.png" alt="image"></a>
              </div>

              <p style="text-align: justify;"> At GreenStride, we're not just a platform; we're a global movement
                dedicated to fostering a sustainable future for our planet.
              </p>
            </div><!-- end clearfix -->
          </div><!-- end col -->

          <div class="col-md-4 col-sm-4 col-xs-12">
            <div class="widget clearfix">
              <div class="widget-title">
                <h3>Pages</h3>
              </div>

              <ul class="footer-links hov">
                <li><a href='index.html'>Home <span class="icon icon-arrow-right2"></span></a></li>
                <li><a href='rewards.html'>Reward<span class="icon icon-arrow-right2"></span></a></li>
                <li><a href='contact.html'>Contact <span class="icon icon-arrow-right2"></span></a></li>
              </ul><!-- end links -->
            </div><!-- end clearfix -->
          </div><!-- end col -->

          <div class="col-md-4 col-sm-4 col-xs-12">
            <div class="footer-distributed widget clearfix">
              <div class="widget-title">
                <h3>Subscribe</h3>
                <p></p>
              </div>

              <div class="footer-right">
                <form method="get" action="#">
                  <input placeholder="Subscribe our newsletter.." name="search">
                  <i class="fa fa-envelope-o"></i>
                </form>
              </div>
            </div><!-- end clearfix -->
          </div><!-- end col -->
        </div><!-- end row -->
      </div><!-- end container -->
    </footer><!-- end footer -->

    <div class="copyrights">
      <div class="container">
        <div class="footer-distributed">
          <div class="footer-left">
            <p class="footer-company-name">All Rights Reserved. &copy; 2024 <a href="#">GreenStride</a>
          </div>


        </div>
      </div><!-- end container -->
    </div><!-- end copyrights -->

    <a href="#" id="scroll-to-top" class="dmtop global-radius"><i class="fa fa-angle-up"></i></a>

    <!-- ALL JS FILES -->


    <!-- Popup JS Start-->

    <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', function () {
        // Get all popup buttons
        var popupBtns = document.querySelectorAll('.popupBtn');

        // Get the popup container
        var popupContainer = document.querySelector('.popupContainer');

        // Get the close button inside the popup
        var closeBtn = document.querySelector('.closeBtn');

        // Function to open the popup
        function openPopup() {
          popupContainer.style.display = 'block';
        }

        // Function to close the popup
        function closePopup() {
          popupContainer.style.display = 'none';
        }

        // Event listener for each popup button
        popupBtns.forEach(function (btn) {
          btn.addEventListener('click', openPopup);
        });

        // Event listener for the close button
        closeBtn.addEventListener('click', closePopup);

        // Event listener to close the popup if user clicks outside of it
        window.addEventListener('click', function (event) {
          if (event.target === popupContainer) {
            closePopup();
          }
        });
      });

    </script>

    <!-- Popup JS end -->
    <script src="js/all.js"></script>
    <!-- ALL PLUGINS -->
    <script src="js/custom.js"></script>
    <script src="js/portfolio.js"></script>
    <script src="js/hoverdir.js"></script>
    <script async id="slcLiveChat" src="../widget.sonetel.com/SonetelWidget.min.js"
      data-account-id="208327372"></script>

    <script>

      async function updateTaskRewards(userId, reward) {
        try {
          const response = await fetch('http://localhost:8800/taskResponse/updateReward', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ userId, reward })
          });

          if (!response.ok) {
            throw new Error('Failed to update task rewards');
          }

          const data = await response.json();
          console.log(data.message); // Log success message
        } catch (error) {
          console.error('Error updating task rewards:', error.message);
          // Handle error (e.g., show error message to user)
        }
      }

      async function getUserRewards(userId) {
        try {
          const response = await fetch(`http://localhost:8800/userReward/get/${userId}`);
          if (!response.ok) {
            throw new Error('Failed to fetch user rewards');
          }
          const data = await response.json();
          return data.userRewards;
        } catch (error) {
          console.error('Error fetching user rewards:', error);
          return null;
        }
      }

      async function getUserTotalRewards(userId) {
        try {
          const response = await fetch(`http://localhost:8800/taskResponse/getReward/${userId}`);
          if (!response.ok) {
            throw new Error('Failed to fetch user rewards');
          }
          const data = await response.json();
          return data.totalRewards;
        } catch (error) {
          console.error('Error fetching user rewards:', error);
          return null;
        }
      }

      function findFirstMissingCode(codes, userRewards) {
        const codesArray = codes.split(',');
        for (let i = 0; i < codesArray.length; i++) {
          const code = codesArray[i];
          console.log("code", code)
          const found = userRewards.some(reward => reward.code === code);
          if (!found) {
            return code;
          }
        }
        return null; // If all codes are present in user rewards
      }
      // Function to make HTTP GET request
      async function openPopup(points, title, code, id) {
        try {

          // Get the user ID from local storage
          const user = JSON.parse(localStorage.getItem('user'));
          if(user == null){
            return
          }
          const userId = user._id;
          const TotalRewards = await getUserTotalRewards(userId);
          if (points <= TotalRewards) {
            // Fetch user rewards from the backend
            const userRewards = await getUserRewards(userId);

            // Find the first missing code
            let desirecode;
            if (userRewards) {
              console.log('User rewards:', userRewards.rewards);
              desirecode = findFirstMissingCode(code, userRewards.rewards);
            } else {
              // If no user rewards found, use the first code from the input
              const codesArray = code.split(',');
              desirecode = codesArray[0];
            }
            console.log('Desired code:', desirecode);

            // Prepare reward data for backend request
            const rewardData = {
              user: userId,
              rewards: {
                id: id,
                code: desirecode,
                exp: true
              }
            };

            // Make an HTTP POST request to the backend
            const response = await fetch('http://localhost:8800/userReward/add', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(rewardData)
            });

            // Check if the request was successful
            const responseData = await response.json();
            if (response.ok) {
              updateTaskRewards(userId, points)
              // Handle success
              const popupContainer = document.querySelector('.popupContainer');
              const popupTitle = popupContainer.querySelector('h1');
              const popupDescription = popupContainer.querySelector('p');

              // Populate popup with reward data
              popupTitle.textContent = title;
              popupDescription.textContent = desirecode;

              // Show the popup
              alert('Reward claimed successfully');
              popupContainer.style.display = 'block';
            } else {
              // Handle errors
              console.error('Failed to claim reward:', responseData.message);
            }
          }
          else {
            alert("you don't have enough points")
          }
        } catch (error) {
          console.error('Error claiming reward:', error);
        }
      }



      async function fetchData() {
        try {
          const response = await fetch('http://localhost:8800/reward/get'); // Assuming your backend API endpoint is /api/rewards
          const data = await response.json();

          // Loop through each reward
          let index = 1;
          data.forEach(reward => {
            const cardDeck = document.querySelector('.card-deck');

            // Create reward box
            const rewardBox = document.createElement('div');
            rewardBox.classList.add('card');

            // Populate reward box with data
            rewardBox.innerHTML = `
                <div class="card-body">
                  <h2 class="">Reward <span>| Box</span></h2>
                  <div class="row g-0">
                    <div class="col-md-4">
                      <img src="images/rewards/Picture${index++}.png" class="img-fluid rounded-start" style="width: 120px; height: 120px;" alt="...">
                    </div>
                    <div class="col-md-8">
                      <div class="card-body">
                        <h3>${reward.name}</h3>
                        <h1 style="color: gold; font-size: 60px;">${reward.points}</h1>
                        <h3 class="">Points</h3>
                        <hr>
                        <p class="card-text">${reward.des}</p>
                      </div>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                      <button type="button" style="width: 80%;" class="btn btn-lg btn-success popupBtn" onclick="openPopup('${reward.points}','${reward.name}', '${reward.codes}', '${reward._id}')">Claim Reward</button>
                    </div>
                  </div>
                </div>
              `;

            // Append reward box to card deck
            cardDeck.appendChild(rewardBox);
          });
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }

      // Fetch data when DOM content is loaded
      document.addEventListener('DOMContentLoaded', () => {

        fetchData();
      });
    </script>
    <script>
      window.addEventListener("DOMContentLoaded", function () {
        function fetchusername() {
          const userData = JSON.parse(localStorage.getItem('user'));

          // Extract user ID from user data
          const userId = userData ? userData._id : null;

          // Check if user ID is available
          if (!userId) {
            return;
          }
          else {
            const anc = document.getElementById("signinbutton")
            anc.innerText = userData.username
            document.getElementById("dashboard").classList.remove("hidden");
          }
        }
        fetchusername()
      })
    </script>
    <script>
      function handleLogout() {
        localStorage.setItem("user", null)
        window.location.reload();
      }
    </script>

</body>

</html>